import"../chunks/CWj6FrbW.js";import{o as Re,s as le}from"../chunks/BpDpeONt.js";import{i as Se,s as F,j as ne,t as v,f as Te,l as o,m as n,u as L,g as c,k as Ue,$ as ze,n as l,o as z,r as i,x as G,v as Pe}from"../chunks/BxrbYPPH.js";import{i as B}from"../chunks/C_-0o-f2.js";import{e as Ve,i as Ae}from"../chunks/n-s4RcA1.js";import{d as Ee,h as Ze}from"../chunks/DKpueC4a.js";import{b as ce,r as Oe,a as f}from"../chunks/BGk8CD_Q.js";import{b as We}from"../chunks/vV7d1D-f.js";import{P as De}from"../chunks/bafqjiaL.js";import{s as Ie}from"../chunks/3os2E0c7.js";import{S as qe}from"../chunks/bcSGfMA8.js";import{g as de}from"../chunks/CCryTnhq.js";import"../chunks/69_IOA4Y.js";import{R as Fe}from"../chunks/DgJjuvVc.js";import{C as Ge}from"../chunks/DC-n8TqT.js";import{H as Ne}from"../chunks/CATT0rBV.js";import{S as Je}from"../chunks/Rs6EvSgj.js";import{c as ve}from"../chunks/Dcrl4MPd.js";import{s as U,u as me,c as Ke}from"../chunks/iREZRceN.js";import{g as Qe,a as Xe}from"../chunks/C6eE29Wt.js";const Ye=async(R,m,b,S,j,P)=>{me("loading",!0);try{if(!m?.id){U("error","로그인이 필요합니다.");return}const y=await b.posts.insert({community_id:l(S)?.value||null,title:j.title,content:j.content,author_id:m.id});if(j.images.length>0){const s=await P(y.id,j.images);await b.posts.update(y.id,{images:s})}U("success","게시글이 저장되었습니다."),de(`/@${m.handle}/post/${y.id}`,{replaceState:!0})}finally{me("loading",!1)}};var et=v('<meta name="description" content="새로운 게시글을 작성하고 지식을 공유하세요. 이미지와 함께 풍부한 콘텐츠를 만들어보세요.">'),tt=v('<button slot="left" class="flex items-center"><!></button>'),at=v('<h1 slot="center" class="font-semibold"></h1>'),rt=(R,m)=>z(m,!l(m)),it=v('<button class="btn btn-xs btn-outline"> </button>'),st=(R,m,b)=>{m.images.length===0?z(b,"image"):U("warning","업로드된 파일을 먼저 삭제하세요.")},ot=(R,m,b)=>{m.images.length===0?z(b,"video"):U("warning","업로드된 파일을 먼저 삭제하세요.")},lt=v('<div class="absolute inset-0 flex items-center justify-center rounded-lg bg-gray-800"><div class="text-center text-white"><svg class="mx-auto mb-2 h-12 w-12" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h6l2 2h6a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14 9a2 2 0 11-4 0 2 2 0 014 0z"></path></svg> <p class="text-xs">비디오 로딩 중...</p></div></div>'),nt=v('<figure class="relative"><video controls class="w-full rounded-lg" style="max-height: 320px;" preload="metadata"><track kind="captions" label="No captions"></video> <!></figure>',2),ct=v("<figure><!></figure>"),vt=v('<div class="mt-2"><div class="rounded-lg border border-gray-200 p-3"><p class="mb-2 text-xs text-gray-500">실제 게시물에서 이렇게 보입니다:</p> <!></div></div>'),mt=v('<img class="h-full w-full object-cover">'),dt=v('<div class="flex h-full w-full items-center justify-center bg-gray-800"><svg class="h-8 w-8 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h6l2 2h6a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14 9a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div>'),ut=v('<div class="relative ml-3 h-20 w-20 flex-shrink-0 overflow-hidden rounded-lg bg-gray-800"><!> <div class="bg-opacity-30 absolute inset-0 flex items-center justify-center bg-black"><svg class="h-6 w-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M8 5v10l7-5z"></path></svg></div></div>'),gt=v('<img class="ml-3 h-20 w-20 flex-shrink-0 rounded-lg object-cover">'),pt=v('<div class="relative min-w-max"><!> <button aria-label="삭제"><svg class="absolute top-[-2px] left-20" xmlns="http://www.w3.org/2000/svg" width="1.3rem" height="1.3rem" viewBox="0 0 24 24"><path d="m8.4 17l3.6-3.6l3.6 3.6l1.4-1.4l-3.6-3.6L17 8.4L15.6 7L12 10.6L8.4 7L7 8.4l3.6 3.6L7 15.6zm3.6 5q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22"></path></svg></button></div>'),_t=v('<div class="mt-2 flex overflow-x-auto"><label for="input-file"><input type="file" id="input-file" class="hidden"> <div class="flex h-20 w-20 flex-col items-center justify-center gap-1 rounded-lg bg-gray-50"><svg width="20" height="20" viewBox="0 0 24 21" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.14 2.33333L16.275 4.66667H21V18.6667H2.33333V4.66667H7.05833L9.19333 2.33333H14.14ZM15.1667 0H8.16667L6.03167 2.33333H2.33333C1.05 2.33333 0 3.38333 0 4.66667V18.6667C0 19.95 1.05 21 2.33333 21H21C22.2833 21 23.3333 19.95 23.3333 18.6667V4.66667C23.3333 3.38333 22.2833 2.33333 21 2.33333H17.3017L15.1667 0ZM11.6667 8.16667C13.5917 8.16667 15.1667 9.74167 15.1667 11.6667C15.1667 13.5917 13.5917 15.1667 11.6667 15.1667C9.74167 15.1667 8.16667 13.5917 8.16667 11.6667C8.16667 9.74167 9.74167 8.16667 11.6667 8.16667ZM11.6667 5.83333C8.44667 5.83333 5.83333 8.44667 5.83333 11.6667C5.83333 14.8867 8.44667 17.5 11.6667 17.5C14.8867 17.5 17.5 14.8867 17.5 11.6667C17.5 8.44667 14.8867 5.83333 11.6667 5.83333Z" fill="#A9A9A9"></path></svg> <span class="text-xs text-gray-900"> </span></div></label> <div class="flex flex-row"></div></div>'),ft=v('<!> <main class="mx-4"><div class="rounded-lg border border-gray-200"><!></div> <div class="mt-6"><div class="flex items-center justify-between"><span class="ml-1 text-sm font-medium">썸네일 이미지 (선택)</span> <!></div> <div class="my-3 flex gap-2"><button>이미지 업로드</button> <button>영상 업로드</button></div> <!></div> <div class="mt-8"><p class="ml-1 text-sm font-medium">글 제목</p> <div class="mt-2"><input type="text" class="input input-bordered focus:border-primary h-[52px] w-full focus:outline-none"></div></div> <div class="mt-8 flex flex-col"><div class="flex items-center justify-between"><p class="ml-1 text-sm font-medium">글 내용</p></div> <div class="mt-2"><!></div></div></main> <div class="fixed bottom-0 w-full max-w-screen-md bg-white px-5 py-3.5"><div class="pb-safe flex space-x-2"><button class="btn btn-primary flex flex-1 items-center justify-center">게시하기</button></div></div>',1);function At(R,m){Se(m,!0);const b=Qe(),S=Xe();let j=G(()=>{let{community_members:e}=m.data;return e});const P=G(()=>[{value:null,label:"모두에게",group:"대상"},...(l(j)||[]).map(e=>({value:e.communities.id,label:e.communities.title,group:"커뮤니티"}))]);let y=F(ne({value:null,label:"모두에게",group:"대상"})),s=ne({title:"",content:"",images:[]}),u=F("image"),V=F(!1);const ue=e=>/\.(mp4|mov|webm|ogg)$/i.test(e),ge=e=>new Promise(t=>{const a=document.createElement("video"),r=document.createElement("canvas"),p=r.getContext("2d");a.preload="metadata",a.muted=!0,a.crossOrigin="anonymous",a.onloadedmetadata=()=>{r.width=80,r.height=80,a.currentTime=Math.min(1,a.duration/2)},a.onseeked=()=>{try{p.drawImage(a,0,0,80,80);const d=r.toDataURL("image/jpeg",.8);t(d)}catch(d){console.error("Error generating video thumbnail:",d),t(null)}},a.onerror=d=>{console.error("Video loading error:",d),t(null)},a.src=e.uri});Re(()=>{if(!Ke(b)){de("/login");return}});const pe=e=>{const t=[...s.images];t.splice(e,1),s.images=t},_e=async(e,t)=>Promise.all(t.map(async(a,r)=>{const p=a.name.split(".").pop(),d=`${e}/${Date.now()}-${r}.${p}`;return await S.post_images.upload(d,a),{uri:`${De}/storage/v1/object/public/posts/images/${d}`}})),fe=async e=>{const t=e.target.files;let a=[];if(l(u)==="image"){a=[...s.images];for(let r=0;r<t.length;r++)t[r].type.startsWith("image/")&&(t[r].uri=URL.createObjectURL(t[r]),a.push(t[r]));if(a.length>7){alert("이미지 개수는 7개를 초과할 수 없습니다.");return}}else if(l(u)==="video"){if(t.length>1){alert("영상은 1개만 업로드할 수 있습니다.");return}if(!t[0].type.startsWith("video/")){alert("영상 파일만 업로드할 수 있습니다.");return}t[0].uri=URL.createObjectURL(t[0]);try{const r=await ge(t[0]);r&&(t[0].thumbnail=r)}catch(r){console.error("Failed to generate video thumbnail:",r)}a=[t[0]]}s.images=a,e.target.value=""};var N=ft();Ze(e=>{var t=et();ze.title="게시글 작성 | 문",c(e,t)});var J=Te(N);Ne(J,{$$slots:{left:(e,t)=>{var a=tt();a.__click=function(...p){Ie?.apply(this,p)};var r=o(a);Fe(r,{size:26,get color(){return ve.gray[600]}}),i(a),c(e,a)},center:(e,t)=>{var a=at();a.textContent="게시글 작성",c(e,a)}}});var A=n(J,2),E=o(A),be=o(E);qe(be,{get items(){return l(P)},groupBy:e=>e.group,clearable:!1,get value(){return l(y)},set value(e){z(y,e,!0)}}),i(E);var Z=n(E,2),O=o(Z),he=n(o(O),2);{var xe=e=>{var t=it();t.__click=[rt,V];var a=o(t,!0);i(t),L(()=>le(a,l(V)?"목록 보기":"미리보기")),c(e,t)};B(he,e=>{s.images.length>0&&e(xe)})}i(O);var W=n(O,2),D=o(W);let K;D.__click=[st,s,u];var Q=n(D,2);let X;Q.__click=[ot,s,u],i(W);var ye=n(W,2);{var we=e=>{var t=vt(),a=o(t),r=n(o(a),2);{var p=h=>{var _=nt(),w=o(_),g=n(w,2);{var k=C=>{var T=lt();c(C,T)};B(g,C=>{s.images[0].thumbnail||C(k)})}i(_),L(()=>{f(w,"src",s.images[0].uri),f(w,"poster",s.images[0].thumbnail||"")}),c(h,_)},d=h=>{var _=ct(),w=o(_);const g=G(()=>s.images.map(k=>k.uri));Ge(w,{get images(){return l(g)}}),i(_),c(h,_)};B(r,h=>{ue(s.images[0].uri)?h(p):h(d,!1)})}i(a),i(t),c(e,t)},ke=e=>{var t=_t(),a=o(t),r=o(a);r.__change=fe;var p=n(r,2),d=n(o(p),2),h=o(d,!0);i(d),i(p),i(a);var _=n(a,2);Ve(_,21,()=>s.images,Ae,(w,g,k)=>{var C=pt(),T=o(C);{var Le=$=>{var x=ut(),He=o(x);{var Me=H=>{var M=mt();f(M,"key",k),L(()=>{f(M,"src",l(g).thumbnail),f(M,"alt",l(g).name)}),c(H,M)},Be=H=>{var M=dt();c(H,M)};B(He,H=>{l(g).thumbnail?H(Me):H(Be,!1)})}Pe(2),i(x),c($,x)},je=$=>{var x=gt();f(x,"key",k),L(()=>{f(x,"src",l(g).uri),f(x,"alt",l(g).name)}),c($,x)};B(T,$=>{l(g).type&&l(g).type.startsWith("video/")?$(Le):$(je,!1)})}var q=n(T,2);q.__click=()=>pe(k);var oe=o(q),$e=o(oe);i(oe),i(q),i(C),L(()=>f($e,"fill",ve.gray[900])),c(w,C)}),i(_),i(t),L(()=>{f(r,"accept",l(u)==="image"?"image/*":"video/*"),r.multiple=l(u)==="image",le(h,l(u)==="image"?`${s.images.length}/7`:`${s.images.length}/1`)}),c(e,t)};B(ye,e=>{l(V)&&s.images.length>0?e(we):e(ke,!1)})}i(Z);var I=n(Z,2),Y=n(o(I),2),ee=o(Y);Oe(ee),i(Y),i(I);var te=n(I,2),ae=n(o(te),2),Ce=o(ae);Je(Ce,{get content(){return s.content},set content(e){s.content=e}}),i(ae),i(te),i(A);var re=n(A,2),ie=o(re),se=o(ie);se.__click=[Ye,b,S,y,s,_e],i(ie),i(re),L((e,t)=>{K=ce(D,1,`btn btn-sm  ${l(u)==="image"?"btn-primary":"bg-gray-100"}`,null,K,e),X=ce(Q,1,`btn btn-sm ${l(u)==="video"?"btn-primary":"bg-gray-100"}`,null,X,t),se.disabled=s.title.length===0||s.content.length===0},[()=>({selected:l(u)==="image"}),()=>({selected:l(u)==="video"})]),We(ee,()=>s.title,e=>s.title=e),c(R,N),Ue()}Ee(["click","change"]);export{At as component};
