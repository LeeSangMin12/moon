import"../chunks/CWj6FrbW.js";import{i as Qt,j as I,t as $,f as st,m as s,x as M,s as rt,l as t,u as D,g as x,k as Tt,$ as Ut,n as r,r as e,e as Vt,o as y}from"../chunks/BxrbYPPH.js";import{s as u}from"../chunks/BpDpeONt.js";import{i as B}from"../chunks/C_-0o-f2.js";import{e as Wt,i as Xt}from"../chunks/n-s4RcA1.js";import{d as Yt,h as Zt,r as te}from"../chunks/DKpueC4a.js";import{r as E}from"../chunks/BGk8CD_Q.js";import{b as L}from"../chunks/vV7d1D-f.js";import{c as ee}from"../chunks/Dcrl4MPd.js";import{g as ae,a as se}from"../chunks/C6eE29Wt.js";import{a as S,b as re,c as oe,u as Lt,s as ot}from"../chunks/iREZRceN.js";import{g as Pt}from"../chunks/CCryTnhq.js";import"../chunks/69_IOA4Y.js";import{R as ie}from"../chunks/DgJjuvVc.js";import{H as ne}from"../chunks/CATT0rBV.js";const de=(z,c,H,d)=>{y(c,null),y(H,""),y(d,"")},le=async(z,c,H,d,C,G,J,_,j,p,i,g,b)=>{if(!(!oe(c)||!r(H))){Lt("loading",!0);try{const v={buyer_id:c.id,seller_id:d.users.id,service_id:d.id,service_title:d.title,quantity:C,unit_price:d.price,commission_amount:r(G),total_with_commission:r(J),coupon_id:r(_)?.id||null,coupon_discount:r(j),depositor_name:p.depositor_name.trim(),bank:p.bank.trim(),account_number:p.account_number.trim(),buyer_contact:p.buyer_contact.trim(),special_request:p.special_request.trim()},P=await i.service_orders.insert(v);if(r(_)&&(await i.user_coupons.insert({user_id:c.id,coupon_id:r(_).id,order_id:P.id,discount_amount:r(j)}),await i.coupons.increment_usage(r(_).id)),g.length>0){const R=g.map(m=>({order_id:P.id,option_id:m.id,option_name:m.name,option_price:m.price_add}));await i.order_options.insert_bulk(R)}try{d?.users?.id&&d.users.id!==c.id&&await i.notifications.insert({recipient_id:d.users.id,actor_id:c.id,type:"order.created",resource_type:"order",resource_id:String(P.id),payload:{service_id:d.id,service_title:d.title,total:b},link_url:`/@${d.users.handle}/accounts/orders`})}catch(R){console.error("Failed to insert notification:",R)}ot("success","주문이 성공적으로 접수되었습니다!"),Pt(`/@${c.handle}/accounts/orders`)}catch(v){console.error("주문 생성 실패:",v),ot("error","주문 접수에 실패했습니다. 다시 시도해주세요.")}finally{Lt("loading",!1)}}};var ce=(z,c)=>Pt(`/service/${c.id}`,{replaceState:!0}),ue=$('<button slot="left"><!></button>'),ve=$('<h1 slot="center" class="font-semibold">주문하기</h1>'),_e=$('<div class="flex justify-between pl-3"><span class="text-gray-500"> </span> <span class="text-gray-700"> </span></div>'),pe=$('<div class="flex justify-between text-sm"><span class="text-blue-600">쿠폰 할인</span> <span class="font-medium text-blue-600"> </span></div>'),me=(z,c)=>z.key==="Enter"&&c(),be=$('<p class="mt-2 text-sm text-red-600"> </p>'),fe=$('<div class="flex gap-2"><input type="text" placeholder="쿠폰 코드 입력" class="input input-bordered h-11 flex-1 focus:border-gray-400 focus:outline-none"> <button class="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">적용</button></div> <!>',1),xe=$('<div class="flex items-center justify-between rounded-lg bg-blue-50 p-3"><div class="flex-1"><p class="font-medium text-blue-900"> </p> <p class="text-sm text-blue-700"> </p></div> <button class="ml-3 text-sm font-medium text-blue-600 hover:text-blue-800">취소</button></div>'),ye=()=>{re("101-2094-2262-04","계좌번호가 복사되었습니다.")},ge=$('<!> <main class="mx-4 pb-24"><div class="mt-4 rounded-lg border border-gray-200 bg-white p-4"><h2 class="mb-3 text-base font-semibold text-gray-900">주문 내용</h2> <div class="space-y-2 text-sm"><div class="flex justify-between"><span class="text-gray-600"> </span> <span class="font-medium"> </span></div> <!> <div class="flex justify-between"><span class="text-gray-600">수량</span> <span class="font-medium"> </span></div> <div class="my-3 h-px bg-gray-200"></div> <div class="flex justify-between text-sm"><span class="text-gray-600">소계</span> <span class="font-medium text-gray-900"> </span></div> <!> <div class="my-2 h-px bg-gray-200"></div> <div class="flex justify-between text-base"><span class="font-semibold text-gray-900">최종 결제금액</span> <span class="text-xl font-bold text-blue-600"> </span></div></div></div> <div class="mt-4 rounded-lg border border-gray-200 bg-white p-4"><h3 class="mb-3 text-sm font-semibold text-gray-900">쿠폰</h3> <!></div> <div class="mt-4 rounded-lg border border-gray-200 bg-gray-50 p-4"><h3 class="mb-3 text-sm font-semibold text-gray-900">입금 계좌 안내</h3> <div class="space-y-2 text-sm"><div class="flex items-center justify-between"><div class="flex items-center"><span class="w-16 text-gray-600">은행</span> <span class="font-medium text-gray-900">부산은행</span></div></div> <div class="flex items-center justify-between"><div class="flex items-center"><span class="w-16 text-gray-600">예금주</span> <span class="font-medium text-gray-900">퓨처밴스 이상민</span></div></div> <div class="flex items-center justify-between"><div class="flex items-center"><span class="w-16 text-gray-600">계좌번호</span> <span class="text-primary font-medium">101-2094-2262-04</span></div> <button class="rounded-md border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-100">복사</button></div></div></div> <div class="mt-6"><h2 class="mb-4 text-base font-semibold text-gray-900">입금 정보</h2> <div class="space-y-4"><div><label class="mb-2 block text-sm font-medium text-gray-700">입금자명</label> <input type="text" placeholder="입금자명을 입력해주세요" class="input input-bordered h-12 w-full focus:border-gray-400 focus:outline-none"></div> <div><label class="mb-2 block text-sm font-medium text-gray-700">은행</label> <input type="text" placeholder="은행명을 입력해주세요" class="input input-bordered h-12 w-full focus:border-gray-400 focus:outline-none"></div> <div><label class="mb-2 block text-sm font-medium text-gray-700">계좌번호</label> <input type="text" placeholder="계좌번호를 입력해주세요" class="input input-bordered h-12 w-full focus:border-gray-400 focus:outline-none"></div> <div><label class="mb-2 block text-sm font-medium text-gray-700">연락처</label> <input type="text" placeholder="전화번호 또는 카카오톡 ID" class="input input-bordered h-12 w-full focus:border-gray-400 focus:outline-none"></div> <div><label class="mb-2 block text-sm font-medium text-gray-700">특별 요청사항 (선택)</label> <textarea placeholder="추가로 요청하실 내용이 있으면 입력해주세요" rows="3" class="textarea textarea-bordered w-full resize-none focus:border-gray-400 focus:outline-none"></textarea></div></div></div></main> <div class="fixed bottom-0 w-full max-w-screen-md border-gray-200 bg-white px-4 py-3"><div class="pb-safe"><button class="btn btn-primary h-12 w-full rounded-lg text-base font-medium disabled:cursor-not-allowed disabled:opacity-50"> </button></div></div>',1);function Fe(z,c){Qt(c,!0);const H=ae(),d=se();let{service:C,quantity:G,selected_options:J}=c.data,_=I(C),j=I(G),p=I(J),i=I({depositor_name:"",bank:"",account_number:"",buyer_contact:"",special_request:""}),g=rt(""),b=rt(null),v=rt("");const P=_.price*j,R=p.reduce((a,o)=>a+o.price_add,0)*j,m=P+R,A=M(()=>r(b)?d.coupons.calculate_discount(r(b),m):0),K=M(()=>m-r(A)),Rt=M(()=>Math.floor(m*.05)),it=async()=>{if(y(v,""),!r(g).trim()){y(v,"쿠폰 코드를 입력해주세요.");return}const a=await d.coupons.select_by_code(r(g).trim());if(!a){y(v,"존재하지 않는 쿠폰입니다.");return}const o=await d.coupons.validate_coupon(a,H.id,"service_purchase",m);if(!o.valid){y(v,o.message,!0);return}y(b,a,!0),ot("success","쿠폰이 적용되었습니다!")},nt=M(()=>i.depositor_name.trim()&&i.bank.trim()&&i.account_number.trim()&&i.buyer_contact.trim());var dt=ge();Zt(a=>{Ut.title="주문하기 | 문"});var lt=st(dt);ne(lt,{$$slots:{left:(a,o)=>{var n=ue();n.__click=[ce,_];var l=t(n);ie(l,{size:26,get color(){return ee.gray[600]}}),e(n),x(a,n)},center:(a,o)=>{var n=ve();x(a,n)}}});var N=s(lt,2),O=t(N),ct=s(t(O),2),Q=t(ct),T=t(Q),At=t(T,!0);e(T);var ut=s(T,2),Dt=t(ut);e(ut),e(Q);var vt=s(Q,2);{var Et=a=>{var o=Vt(),n=st(o);Wt(n,17,()=>p,Xt,(l,h)=>{var w=_e(),q=t(w),f=t(q);e(q);var k=s(q,2),at=t(k);e(k),e(w),D(Ot=>{u(f,`+ ${r(h).name??""}`),u(at,`₩${Ot??""}`)},[()=>S(r(h).price_add)]),x(l,w)}),x(a,o)};B(vt,a=>{p.length>0&&a(Et)})}var U=s(vt,2),_t=s(t(U),2),Ft=t(_t);e(_t),e(U);var V=s(U,4),pt=s(t(V),2),It=t(pt);e(pt),e(V);var mt=s(V,2);{var Mt=a=>{var o=pe(),n=s(t(o),2),l=t(n);e(n),e(o),D(h=>u(l,`-₩${h??""}`),[()=>S(r(A))]),x(a,o)};B(mt,a=>{r(A)>0&&a(Mt)})}var bt=s(mt,4),ft=s(t(bt),2),Bt=t(ft);e(ft),e(bt),e(ct),e(O);var W=s(O,2),Ct=s(t(W),2);{var Gt=a=>{var o=fe(),n=st(o),l=t(n);E(l),l.__keydown=[me,it];var h=s(l,2);h.__click=it,e(n);var w=s(n,2);{var q=f=>{var k=be(),at=t(k,!0);e(k),D(()=>u(at,r(v))),x(f,k)};B(w,f=>{r(v)&&f(q)})}L(l,()=>r(g),f=>y(g,f)),x(a,o)},Jt=a=>{var o=xe(),n=t(o),l=t(n),h=t(l,!0);e(l);var w=s(l,2),q=t(w);e(w),e(n);var f=s(n,2);f.__click=[de,b,g,v],e(o),D(k=>{u(h,r(b).name),u(q,`-₩${k??""} 할인`)},[()=>S(r(A))]),x(a,o)};B(Ct,a=>{r(b)?a(Jt,!1):a(Gt)})}e(W);var X=s(W,2),xt=s(t(X),2),yt=s(t(xt),4),Kt=s(t(yt),2);Kt.__click=[ye],e(yt),e(xt),e(X);var gt=s(X,2),ht=s(t(gt),2),Y=t(ht),wt=s(t(Y),2);E(wt),e(Y);var Z=s(Y,2),kt=s(t(Z),2);E(kt),e(Z);var tt=s(Z,2),$t=s(t(tt),2);E($t),e(tt);var et=s(tt,2),jt=s(t(et),2);E(jt),e(et);var qt=s(et,2),St=s(t(qt),2);te(St),e(qt),e(ht),e(gt),e(N);var zt=s(N,2),Ht=t(zt),F=t(Ht);F.__click=[le,H,nt,_,j,Rt,K,b,A,i,d,p,m];var Nt=t(F);e(F),e(Ht),e(zt),D((a,o,n,l)=>{u(At,_.title),u(Dt,`₩${a??""}`),u(Ft,`${j??""}개`),u(It,`₩${o??""}`),u(Bt,`₩${n??""}`),F.disabled=!r(nt),u(Nt,`₩${l??""} 주문하기`)},[()=>S(_.price),()=>S(m),()=>S(r(K)),()=>S(r(K))]),L(wt,()=>i.depositor_name,a=>i.depositor_name=a),L(kt,()=>i.bank,a=>i.bank=a),L($t,()=>i.account_number,a=>i.account_number=a),L(jt,()=>i.buyer_contact,a=>i.buyer_contact=a),L(St,()=>i.special_request,a=>i.special_request=a),x(z,dt),Tt()}Yt(["click","keydown"]);export{Fe as component};
