# 포트원 결제 시스템 테스트 시나리오

이 문서는 포트원 결제 시스템의 모든 기능을 체계적으로 테스트하고 결과를 기록하는 가이드입니다.

---

## 📋 사전 준비

### 1. 환경 변수 설정

`.env` 파일에 다음 환경 변수 추가:

```bash
# 포트원 V1 API (필수)
PORTONE_REST_API_KEY=5183484805055100
PORTONE_REST_API_SECRET=KnyhFSrAEzsZZNokEBcqM5QE3IdzPaQSxwwK4GQJMCzlerQfji51hfhxg8Cy4cJvFJaanMgDVqTR9HPz

# 가맹점 식별코드는 코드에 이미 설정됨 (imp66011865)
```

### 2. 개발 서버 실행

```bash
npm run dev
```

### 3. 로그인

테스트 페이지는 로그인이 필요합니다. 먼저 로그인하세요.

---

## 🧪 테스트 시나리오

### 시나리오 1: 정상 결제 프로세스 ✅

**목적**: 정상적인 카드 결제 흐름 검증

#### 단계:

1. `/payment` 페이지 접속
2. 테스트 금액 입력: **1,000원**
3. **"결제하기"** 버튼 클릭
4. 포트원 결제창 확인
5. 테스트 카드 정보 입력:
   - 카드번호: `9446-0175-6200-9013`
   - 유효기간: `2025-12`
   - CVC: `777`
   - 비밀번호 앞 2자리: `00`
6. 결제 완료 확인

#### 검증 항목:

- [ ] 포트원 결제창이 정상적으로 열리는가?
- [ ] 카드 정보 입력 후 결제가 완료되는가?
- [ ] "결제가 완료되었습니다!" 토스트 메시지가 표시되는가?
- [ ] 거래 내역 테이블에 새 거래가 추가되는가?
- [ ] 통계 카드(총 거래, 완료, 총 결제 금액)가 업데이트되는가?
- [ ] 거래 상태가 "완료"로 표시되는가?
- [ ] imp_uid가 정상적으로 저장되는가?
- [ ] 카드사 정보(카드사명, 마스킹된 카드번호)가 표시되는가?

#### 📸 스크린샷 캡처:

1. `결제_1_결제창.png` - 포트원 결제창
2. `결제_2_완료.png` - 결제 완료 화면
3. `결제_3_거래내역.png` - 거래 내역 테이블

---

### 시나리오 2: 여러 건의 결제 ✅

**목적**: 다양한 금액으로 여러 건의 결제 검증

#### 단계:

1. 다음 금액들로 각각 결제 진행:
   - 100원 (최소 금액)
   - 5,000원
   - 10,000원
   - 50,000원

#### 검증 항목:

- [ ] 모든 금액이 정상적으로 결제되는가?
- [ ] 통계가 정확하게 누적되는가?
- [ ] 거래 내역이 최신순으로 정렬되는가?

#### 📸 스크린샷 캡처:

4. `결제_4_다중거래.png` - 여러 건의 거래 내역

---

### 시나리오 3: 결제 취소 ✅

**목적**: 완료된 결제의 취소 프로세스 검증

#### 단계:

1. 거래 내역에서 완료된 거래의 **"취소"** 버튼 클릭
2. 확인 대화상자에서 **"확인"** 클릭
3. 취소 완료 확인

#### 검증 항목:

- [ ] 취소 확인 대화상자가 표시되는가?
- [ ] "결제가 취소되었습니다." 토스트 메시지가 표시되는가?
- [ ] 거래 상태가 "취소"로 변경되는가?
- [ ] 통계가 업데이트되는가? (완료 -1, 취소 +1, 총 금액 감소)
- [ ] 브라우저 콘솔에 에러가 없는가?

#### 📸 스크린샷 캡처:

5. `취소_1_확인창.png` - 취소 확인 대화상자
6. `취소_2_완료.png` - 취소 후 거래 내역

---

### 시나리오 4: 결제 실패 ✅

**목적**: 잘못된 카드 정보로 결제 실패 검증

#### 단계:

1. 테스트 금액 입력: **2,000원**
2. **"결제하기"** 버튼 클릭
3. 포트원 결제창에서 **잘못된 카드 정보** 입력 또는 **"취소"** 버튼 클릭
4. 결제 실패 확인

#### 검증 항목:

- [ ] 결제 실패 메시지가 표시되는가?
- [ ] 거래가 DB에 저장되지 않거나 상태가 "취소"인가?
- [ ] 통계가 잘못 업데이트되지 않는가?

#### 📸 스크린샷 캡처:

7. `실패_1_에러메시지.png` - 결제 실패 메시지

---

### 시나리오 5: 금액 범위 검증 ✅

**목적**: 최소/최대 금액 제한 검증

#### 단계:

1. **99원** 입력 후 결제하기 클릭 → 에러 확인
2. **10,000,001원** 입력 후 결제하기 클릭 → 에러 확인
3. **100원** 입력 후 결제하기 클릭 → 정상 처리 확인
4. **10,000,000원** 입력 후 결제하기 클릭 → 정상 처리 확인

#### 검증 항목:

- [ ] 범위 밖의 금액은 에러 메시지가 표시되는가?
- [ ] 범위 내의 금액은 정상 처리되는가?

#### 📸 스크린샷 캡처:

8. `검증_1_금액범위.png` - 금액 범위 에러 메시지

---

### 시나리오 6: 거래 내역 필터링 ✅

**목적**: 상태별 필터 기능 검증

#### 단계:

1. 상태 필터 드롭다운에서 **"완료"** 선택
2. 완료된 거래만 표시되는지 확인
3. **"취소"** 선택
4. 취소된 거래만 표시되는지 확인
5. **"전체"** 선택
6. 모든 거래가 표시되는지 확인

#### 검증 항목:

- [ ] 필터가 정확하게 작동하는가?
- [ ] 필터 변경 시 테이블이 즉시 업데이트되는가?

#### 📸 스크린샷 캡처:

9. `필터_1_완료.png` - 완료 필터
10. `필터_2_취소.png` - 취소 필터

---

### 시나리오 7: 웹훅 검증 (고급) ⚠️

**목적**: 포트원 서버에서 웹훅 수신 및 금액 검증

#### 사전 준비:

로컬 환경에서는 ngrok 또는 localtunnel 필요:

```bash
# ngrok 사용
ngrok http 5173

# 포트원 관리자 페이지에서 웹훅 URL 설정
# 예: https://abc123.ngrok.io/api/portone/webhook
```

#### 단계:

1. 웹훅 URL 설정 후 결제 진행
2. 서버 콘솔 로그 확인
3. 금액 검증 로그 확인

#### 검증 항목:

- [ ] 웹훅이 정상적으로 수신되는가?
- [ ] 금액 검증이 수행되는가? (`[PortOne Webhook] Amount verified` 로그)
- [ ] 금액 불일치 시 에러가 발생하는가?

#### 📸 스크린샷 캡처:

11. `웹훅_1_로그.png` - 서버 콘솔 로그

---

### 시나리오 8: 보안 검증 (위·변조 방지) 🔒

**목적**: 클라이언트에서 금액 변조 시도 시 검증

#### 단계:

1. 브라우저 개발자 도구 → Console 탭 열기
2. 다음 코드 실행 (금액 변조 시도):
   ```javascript
   // 결제 요청 전 금액 변조 (실제로는 DB에 저장된 금액으로 검증됨)
   // 이 테스트는 웹훅에서 포트원 서버의 실제 금액과 DB 금액을 비교하는 것을 검증
   ```
3. 웹훅에서 금액 불일치 감지 확인

#### 검증 항목:

- [ ] 웹훅에서 금액 불일치가 감지되는가?
- [ ] `Amount mismatch` 에러가 로그에 기록되는가?
- [ ] 거래가 거부되는가?

#### 📸 스크린샷 캡처:

12. `보안_1_금액검증.png` - 금액 검증 에러 로그

---

### 시나리오 9: 로그인 체크 ✅

**목적**: 비로그인 상태에서 결제 방지

#### 단계:

1. 로그아웃
2. `/payment` 페이지 접속 → 로그인 페이지로 리다이렉트 확인

#### 검증 항목:

- [ ] 비로그인 시 자동으로 로그인 페이지로 이동하는가?

#### 📸 스크린샷 캡처:

13. `보안_2_로그인체크.png` - 로그인 리다이렉트

---

### 시나리오 10: 통계 정확성 검증 ✅

**목적**: 통계 카드의 수치가 정확한지 검증

#### 단계:

1. 페이지를 새로고침하여 통계 재계산
2. 거래 내역과 통계 카드의 수치 비교:
   - 총 거래 수 = 거래 내역 테이블의 총 row 수
   - 완료 건수 = "완료" 상태 거래 수
   - 취소/환불 건수 = "취소" + "환불" 상태 거래 수
   - 총 결제 금액 = 완료 상태 거래들의 금액 합계

#### 검증 항목:

- [ ] 모든 통계 수치가 정확한가?
- [ ] 페이지 새로고침 후에도 통계가 일치하는가?

#### 📸 스크린샷 캡처:

14. `통계_1_최종.png` - 최종 통계 화면

---

## 📊 테스트 결과 요약표

| 시나리오 | 상태 | 비고 |
|---------|------|------|
| 1. 정상 결제 프로세스 | ⬜ 통과 / ⬜ 실패 | |
| 2. 여러 건의 결제 | ⬜ 통과 / ⬜ 실패 | |
| 3. 결제 취소 | ⬜ 통과 / ⬜ 실패 | |
| 4. 결제 실패 | ⬜ 통과 / ⬜ 실패 | |
| 5. 금액 범위 검증 | ⬜ 통과 / ⬜ 실패 | |
| 6. 거래 내역 필터링 | ⬜ 통과 / ⬜ 실패 | |
| 7. 웹훅 검증 | ⬜ 통과 / ⬜ 실패 / ⬜ 미실시 | |
| 8. 보안 검증 | ⬜ 통과 / ⬜ 실패 / ⬜ 미실시 | |
| 9. 로그인 체크 | ⬜ 통과 / ⬜ 실패 | |
| 10. 통계 정확성 | ⬜ 통과 / ⬜ 실패 | |

---

## 🔍 데이터베이스 확인

테스트 후 데이터베이스에서 직접 확인:

```sql
-- 모든 거래 조회
SELECT * FROM payment_transactions ORDER BY created_at DESC;

-- 상태별 통계
SELECT status, COUNT(*), SUM(amount)
FROM payment_transactions
GROUP BY status;

-- 특정 사용자의 거래
SELECT * FROM payment_transactions
WHERE user_id = 'your-user-id'
ORDER BY created_at DESC;
```

---

## ⚠️ 알려진 이슈 및 제한사항

1. **테스트 환경**: 실제 결제가 이루어지지 않음 (포트원 테스트 모드)
2. **웹훅 로컬 테스트**: ngrok 등 터널링 도구 필요
3. **환경 변수**: `PORTONE_REST_API_KEY`, `PORTONE_REST_API_SECRET` 설정 필요

---

## 📝 테스트 완료 체크리스트

- [ ] 모든 시나리오 실행 완료
- [ ] 스크린샷 14장 캡처 완료
- [ ] 테스트 결과 요약표 작성 완료
- [ ] 발견된 버그 기록 완료
- [ ] 개선 사항 제안 작성 완료

---

## 🐛 버그 리포트 템플릿

발견된 버그가 있다면 다음 형식으로 기록:

```
버그 #1
- 시나리오: [시나리오 번호]
- 증상: [발생한 문제]
- 재현 방법: [단계별 설명]
- 예상 결과: [기대했던 동작]
- 실제 결과: [실제 발생한 동작]
- 스크린샷: [파일명]
```

---

테스트 완료 후 이 문서와 스크린샷들을 `PAYMENT_REPORT.md`에 정리하세요!
